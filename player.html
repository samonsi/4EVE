<!DOCTYPE html>
<html>
<head>
    <title>PLAYIDTV - Player</title>
    <style>
        body {
            background-color: #000;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }
        #player-container {
            width: 100%;
            height: 100%;
        }
        #player {
            width: 100%;
            height: 100%;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@clappr/player@0.4.0/dist/clappr.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/shaka-player@2.5.10/dist/shaka-player.compiled.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/clappr/dash-shaka-playback@latest/dist/dash-shaka-playback.external.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/level-selector@latest/dist/level-selector.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/clappr-audio-selector@latest/dist/clappr-audio-selector.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/clappr-pip-plugin@latest/dist/clappr-pip-plugin.min.js"></script>
</head>
<body>
    <div id="player-container">
        <div id="player"></div>
    </div>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const source = urlParams.get('source');
        const keyId = urlParams.get('keyId');
        const keyValue = urlParams.get('keyValue');
        const mimeType = urlParams.get('mimeType');
        const channelName = decodeURIComponent(urlParams.get('channelName'));

        if (source) {
            // Apply CORS Proxy directly to the video source URL
            const proxyUrl = "https://api.allorigins.win/raw?url=";
            const finalSource = source.startsWith("http") ? proxyUrl + encodeURIComponent(source) : source;

            let plugins = [LevelSelector, DashShakaPlayback];
            if (typeof ClapprAudioSelector !== 'undefined') plugins.push(ClapprAudioSelector);
            if (typeof PipPlugin !== 'undefined') plugins.push(PipPlugin);

            const playerConfig = {
                source: finalSource, // Use the proxied URL
                autoPlay: true,
                height: '100%',
                width: '100%',
                plugins: plugins,
                parentId: '#player',
            };

            if (mimeType) playerConfig.mimeType = mimeType;
            if (keyId && keyValue) {
                playerConfig.shakaConfiguration = {
                    drm: {
                        clearKeys: {
                            [keyId]: keyValue
                        }
                    }
                };
            }

            const playerInstance = new Clappr.Player(playerConfig);
            document.title = 'PLAYIDTV - ' + channelName;
        } else {
            document.getElementById('player-container').innerHTML = '<h2>Video source not found.</h2>';
        }
    </script>
</body>
</html>
